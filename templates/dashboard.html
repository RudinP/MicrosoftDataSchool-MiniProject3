{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-4">
        <div class="card kpi-card">
            <div class="card-body">
                <div class="kpi-label">ì´ ì§€í•˜ì²  ì—­ ìˆ˜</div>
                <div class="kpi-value">{{ total_stations }}</div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card kpi-card">
            <div class="card-body">
                <div class="kpi-label">ì´ ìŠ¹í•˜ì°¨ ìŠ¹ê° ìˆ˜</div>
                <div class="kpi-value">{{ "{:,}".format(total_boarding) }}</div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card kpi-card">
            <div class="card-body">
                <div class="kpi-label">ë“±ë¡ëœ ìŒì‹ì  ìˆ˜</div>
                <div class="kpi-value">{{ "{:,}".format(total_restaurants) }}</div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">ğŸš† ìŠ¹ê° ìˆ˜ ìƒìœ„ 10ê°œ ì—­</div>
            <div class="card-body">
                <canvas id="stationsChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">ğŸ½ï¸ ìŒì‹ì  ì—…ì¢…ë³„ ë¶„í¬</div>
            <div class="card-body">
                <canvas id="restaurantsChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">ğŸ“Š ì‹¬í™” ë¶„ì„: ìì¹˜êµ¬ë³„ í˜„í™©</div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="analysisTab" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="stations-tab" data-bs-toggle="tab" href="#stations"
                            role="tab">ì§€ì—­ë³„ ì—­ì‚¬ ìˆ˜</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="types-tab" data-bs-toggle="tab" href="#types" role="tab">ìœ ë™ì¸êµ¬ vs ì—…ì¢…</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="closed-tab" data-bs-toggle="tab" href="#closed" role="tab">ìœ ë™ì¸êµ¬ vs
                            íì—…</a>
                    </li>
                </ul>
                <div class="tab-content mt-3" id="analysisTabContent">
                    <div class="tab-pane fade show active" id="stations" role="tabpanel">
                        <canvas id="stationsDistrictChart"></canvas>
                    </div>
                    <div class="tab-pane fade" id="types" role="tabpanel">
                        <canvas id="trafficTypesChart"></canvas>
                    </div>
                    <div class="tab-pane fade" id="closed" role="tabpanel">
                        <canvas id="trafficClosedChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        Promise.all([
            fetch('/api/stats').then(res => res.json()),
            fetch('/api/advanced_stats').then(res => res.json())
        ]).then(([statsData, advancedData]) => {
            // Stations Chart
            const stationsCtx = document.getElementById('stationsChart').getContext('2d');
            new Chart(stationsCtx, {
                type: 'bar',
                data: {
                    labels: statsData.top_stations.map(d => d.name),
                    datasets: [{
                        label: 'ì´ ìŠ¹í•˜ì°¨ ìŠ¹ê° ìˆ˜',
                        data: statsData.top_stations.map(d => d.value),
                        backgroundColor: 'rgba(54, 162, 235, 0.6)'
                    }]
                },
                options: { indexAxis: 'y' }
            });

            // Restaurants Chart
            const restaurantsCtx = document.getElementById('restaurantsChart').getContext('2d');
            new Chart(restaurantsCtx, {
                type: 'doughnut',
                data: {
                    labels: statsData.restaurant_types.map(d => d.name),
                    datasets: [{
                        data: statsData.restaurant_types.map(d => d.value),
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                            '#FF9F40', '#C9CBCF', '#7BC225', '#F7464A', '#46BFBD'
                        ]
                    }]
                }
            });

            // 1. Stations by District
            new Chart(document.getElementById('stationsDistrictChart'), {
                type: 'bar',
                data: {
                    labels: advancedData.stations_per_district.map(d => d.district),
                    datasets: [{
                        label: 'ì—­ ê°œìˆ˜',
                        data: advancedData.stations_per_district.map(d => d.count),
                        backgroundColor: '#36A2EB'
                    }]
                }
            });

            // 2. Traffic vs Business Types (Stacked Bar)
            if (advancedData.traffic_vs_types.length > 0) {
                const topDistricts = advancedData.traffic_vs_types.slice(0, 10);
                const types = Object.keys(topDistricts[0].types);
                const datasets = types.map((t, i) => ({
                    label: t,
                    data: topDistricts.map(d => d.types[t]),
                    backgroundColor: `hsla(${i * 60}, 70%, 50%, 0.7)`,
                    stack: 'Stack 0'
                }));

                new Chart(document.getElementById('trafficTypesChart'), {
                    type: 'bar',
                    data: {
                        labels: topDistricts.map(d => d.district),
                        datasets: datasets
                    },
                    options: {
                        plugins: {
                            title: { display: true, text: 'ìœ ë™ì¸êµ¬ ìƒìœ„ 10ê°œ ì§€ì—­ ì—…ì¢… ë¶„í¬' }
                        },
                        scales: {
                            x: { stacked: true },
                            y: { stacked: true }
                        }
                    }
                });
            }

            // 3. Traffic vs Closed (Scatter)
            new Chart(document.getElementById('trafficClosedChart'), {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'ìì¹˜êµ¬',
                        data: advancedData.closed_vs_traffic.map(d => ({
                            x: d.traffic,
                            y: d.closed,
                            district: d.district
                        })),
                        backgroundColor: '#FF6384'
                    }]
                },
                options: {
                    scales: {
                        x: { title: { display: true, text: 'ì´ ìœ ë™ì¸êµ¬ (ìŠ¹+í•˜ì°¨)' } },
                        y: { title: { display: true, text: 'íì—… ìŒì‹ì  ìˆ˜' } }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const p = context.raw;
                                    return `${p.district}: ìœ ë™ì¸êµ¬ ${p.x.toLocaleString()}, íì—… ${p.y.toLocaleString()}ê±´`;
                                }
                            }
                        }
                    }
                }
            });

        });
    });
</script>
{% endblock %}